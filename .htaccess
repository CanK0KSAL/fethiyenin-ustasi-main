# ==========================================================
# FethiyeninUstası — v2.1
# FU-8001: /media → /assets/media yol eşleştirme (internal)
# + Statik dosya MIME türleri, uzun önbellek ve sıkıştırma
# Not: URL değişmeden içeride /assets/media’dan sunulur (rewrite).
# ==========================================================

# -----------------------------
# 1) Güvenli varsayılanlar
# -----------------------------
Options -Indexes
ServerSignature Off

# -----------------------------
# 1.1) PHP ve Form İstekleri (POST/OPTIONS)
# -----------------------------
# PHP dosyalarının çalışması için
<FilesMatch "\.php$">
  # POST ve OPTIONS metodlarına izin ver (CORS preflight için)
  <Limit POST OPTIONS>
    Order allow,deny
    Allow from all
  </Limit>
</FilesMatch>

# CORS preflight (OPTIONS) istekleri için
<IfModule mod_headers.c>
  # OPTIONS isteği için özel header'lar
  RewriteCond %{REQUEST_METHOD} OPTIONS
  RewriteRule ^(.*)$ $1 [R=200,L]
</IfModule>

# -----------------------------
# 2) MIME türleri (avif/webp vb.)
# -----------------------------
<IfModule mod_mime.c>
  AddType image/avif       avif
  AddType image/avif       AVIF
  AddType image/webp       webp
  AddType image/webp       WEBP
  AddType image/svg+xml    svg SVG
  AddType font/woff2       woff2 WOFF2
</IfModule>

# -------------------------------------------
# 3) /media/* → /assets/media/* (INTERNAL)
#    - Tarayıcı adres çubuğu değişmez
#    - İç linkler /media/... olsa da dosyalar
#      depodaki /assets/media/... yolundan gelir
# -------------------------------------------
<IfModule mod_rewrite.c>
  RewriteEngine On

  # .html uzantılı URL'leri uzantısız yönlendir (301 redirect)
  # Bu kural önce gelmeli, böylece .html ile gelen istekler uzantısız yönlendirilir
  RewriteCond %{THE_REQUEST} \s/+(.+)\.html[\s?] [NC]
  RewriteRule ^ /%1? [R=301,L]

  # Var olan dosya/klasörler aynen servis edilsin
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # Uzantısız URL'leri .html dosyasına yönlendir (internal rewrite)
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_FILENAME}.html -f
  RewriteRule ^(.*)$ $1.html [L]

  # /media/… isteklerini içerde /assets/media/…'a çevir
  RewriteRule ^media/(.*)$ assets/media/$1 [L,NC]

  # (İsteğe bağlı) /Media/… vb. varyasyonlar için de çalışır
  # NC bayrağı zaten büyük/küçük duyarsızdır.
</IfModule>

# ---------------------------------------------------
# 4) Uzun önbellek (immutable) — ?v=YYYY.MM.DD ile
#    sürümlersen, içerik değişiminde yeni versiyon
#    paramı önbelleği kırar (cache-busting).
# ---------------------------------------------------
<IfModule mod_expires.c>
  ExpiresActive On
  # Görseller
  ExpiresByType image/avif       "access plus 1 year"
  ExpiresByType image/webp       "access plus 1 year"
  ExpiresByType image/jpeg       "access plus 1 year"
  ExpiresByType image/png        "access plus 1 year"
  ExpiresByType image/gif        "access plus 1 year"
  ExpiresByType image/svg+xml    "access plus 1 year"
  ExpiresByType image/x-icon     "access plus 1 year"
  # CSS/JS
  ExpiresByType text/css         "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/javascript  "access plus 1 year"
  # Fontlar
  ExpiresByType font/woff2       "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
  # immutable + uzun cache (güncelleme için ?v= kullanıyoruz)
  <FilesMatch "\.(?:avif|webp|png|jpe?g|gif|svg|ico|css|js|woff2)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
</IfModule>

# -----------------------------
# 5) İçerik sıkıştırma (Brotli/Gzip)
# -----------------------------
<IfModule mod_brotli.c>
  BrotliCompLevel 5
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css text/xml application/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml
</IfModule>

<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/css text/xml application/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml
</IfModule>

# -----------------------------
# 6) CORS (gerekirse font/görseller)
# -----------------------------
# <IfModule mod_headers.c>
#   <FilesMatch "\.(?:woff2|svg)$">
#     Header set Access-Control-Allow-Origin "*"
#   </FilesMatch>
# </IfModule>
